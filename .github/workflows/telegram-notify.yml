name: Telegram PR Notifications

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send personalized Telegram notifications
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          USER_MAPPING: ${{ secrets.TELEGRAM_USER_MAPPING }}
        run: |
          send_message() {
            local github_user=$1
            local message=$2
            
            local chat_id=$(echo "$USER_MAPPING" | tr ',' '\n' | grep "^${github_user}:" | cut -d':' -f2)
            
            if [ -n "$chat_id" ]; then
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d chat_id="${chat_id}" \
                -d text="${message}" \
                -d parse_mode=HTML \
                -d disable_web_page_preview=true
              echo "Sent to $github_user (chat_id: $chat_id)"
            else
              echo "No chat_id found for user: $github_user"
            fi
          }
          
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          REPO_NAME="${{ github.repository }}"
          
          if [ "${{ github.event_name }}" == "pull_request_review" ]; then
            REVIEWER="${{ github.event.review.user.login }}"
            STATE="${{ github.event.review.state }}"
            REVIEW_URL="${{ github.event.review.html_url }}"
            
            case $STATE in
              approved)
                MESSAGE="‚úÖ <b>Your PR #${PR_NUMBER} got approved!</b>%0A%0A"
                MESSAGE+="üìù ${PR_TITLE}%0A"
                MESSAGE+="üëç Approved by: @${REVIEWER}%0A"
                MESSAGE+="üì¶ Repo: ${REPO_NAME}%0A"
                MESSAGE+="üîó <a href='${PR_URL}'>Check it out</a>"
                send_message "$PR_AUTHOR" "$MESSAGE"
                ;;
              changes_requested)
                MESSAGE="üîß <b>Changes needed on PR #${PR_NUMBER}</b>%0A%0A"
                MESSAGE+="üìù ${PR_TITLE}%0A"
                MESSAGE+="üë§ Reviewer: @${REVIEWER}%0A"
                MESSAGE+="üí¨ Time to fix some stuff%0A"
                MESSAGE+="üì¶ Repo: ${REPO_NAME}%0A"
                MESSAGE+="üîó <a href='${REVIEW_URL}'>See what's up</a>"
                send_message "$PR_AUTHOR" "$MESSAGE"
                ;;
              commented)
                MESSAGE="üí¨ <b>New review comment on PR #${PR_NUMBER}</b>%0A%0A"
                MESSAGE+="üìù ${PR_TITLE}%0A"
                MESSAGE+="üë§ From: @${REVIEWER}%0A"
                MESSAGE+="üì¶ Repo: ${REPO_NAME}%0A"
                MESSAGE+="üîó <a href='${REVIEW_URL}'>Read it</a>"
                send_message "$PR_AUTHOR" "$MESSAGE"
                ;;
            esac
            
          elif [ "${{ github.event_name }}" == "pull_request_review_comment" ]; then
            COMMENTER="${{ github.event.comment.user.login }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            
            if [ "$COMMENTER" != "$PR_AUTHOR" ]; then
              MESSAGE="üí≠ <b>Code comment on your PR #${PR_NUMBER}</b>%0A%0A"
              MESSAGE+="üìù ${PR_TITLE}%0A"
              MESSAGE+="üë§ From: @${COMMENTER}%0A"
              MESSAGE+="üì¶ Repo: ${REPO_NAME}%0A"
              MESSAGE+="üîó <a href='${COMMENT_URL}'>Check the comment</a>"
              send_message "$PR_AUTHOR" "$MESSAGE"
            fi
            
          elif [ "${{ github.event_name }}" == "issue_comment" ] && [ "${{ github.event.issue.pull_request }}" != "" ]; then
            COMMENTER="${{ github.event.comment.user.login }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            COMMENT_BODY="${{ github.event.comment.body }}"
            
            if [ "$COMMENTER" != "$PR_AUTHOR" ]; then
              COMMENT_PREVIEW=$(echo "$COMMENT_BODY" | head -c 100)
              
              MESSAGE="üí¨ <b>Reply on your PR #${PR_NUMBER}</b>%0A%0A"
              MESSAGE+="üìù ${PR_TITLE}%0A"
              MESSAGE+="üë§ From: @${COMMENTER}%0A"
              MESSAGE+="üì¶ Repo: ${REPO_NAME}%0A"
              MESSAGE+="üîó <a href='${COMMENT_URL}'>See the reply</a>"
              send_message "$PR_AUTHOR" "$MESSAGE"
            fi
          fi
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            ACTION="${{ github.event.action }}"
            ACTOR="${{ github.actor }}"
            
            REVIEWERS="${{ join(github.event.pull_request.requested_reviewers.*.login, ',') }}"
            
            case $ACTION in
              opened)
                if [ -n "$REVIEWERS" ]; then
                  IFS=',' read -ra REVIEWER_ARRAY <<< "$REVIEWERS"
                  for reviewer in "${REVIEWER_ARRAY[@]}"; do
                    MESSAGE="üÜï <b>New PR #${PR_NUMBER} needs your review</b>%0A%0A"
                    MESSAGE+="üìù ${PR_TITLE}%0A"
                    MESSAGE+="üë§ Author: @${PR_AUTHOR}%0A"
                    MESSAGE+="üì¶ Repo: ${REPO_NAME}%0A"
                    MESSAGE+="üîó <a href='${PR_URL}'>Start reviewing</a>"
                    send_message "$reviewer" "$MESSAGE"
                  done
                fi
                ;;
              synchronize)
                if [ -n "$REVIEWERS" ]; then
                  COMMITS_URL="${PR_URL}/commits"
                  IFS=',' read -ra REVIEWER_ARRAY <<< "$REVIEWERS"
                  for reviewer in "${REVIEWER_ARRAY[@]}"; do
                    MESSAGE="üîÑ <b>Fresh changes in PR #${PR_NUMBER}</b>%0A%0A"
                    MESSAGE+="üìù ${PR_TITLE}%0A"
                    MESSAGE+="üë§ Author: @${PR_AUTHOR}%0A"
                    MESSAGE+="‚ú® New commits pushed%0A"
                    MESSAGE+="üì¶ Repo: ${REPO_NAME}%0A"
                    MESSAGE+="üîó <a href='${COMMITS_URL}'>See what changed</a>"
                    send_message "$reviewer" "$MESSAGE"
                  done
                fi
                ;;
              ready_for_review)
                if [ -n "$REVIEWERS" ]; then
                  IFS=',' read -ra REVIEWER_ARRAY <<< "$REVIEWERS"
                  for reviewer in "${REVIEWER_ARRAY[@]}"; do
                    MESSAGE="‚ú® <b>PR #${PR_NUMBER} is ready for review</b>%0A%0A"
                    MESSAGE+="üìù ${PR_TITLE}%0A"
                    MESSAGE+="üë§ Author: @${PR_AUTHOR}%0A"
                    MESSAGE+="üì¶ Repo: ${REPO_NAME}%0A"
                    MESSAGE+="üîó <a href='${PR_URL}'>Let's review this</a>"
                    send_message "$reviewer" "$MESSAGE"
                  done
                fi
                ;;
            esac
          fi
          
          if [ "${{ github.event_name }}" == "issue_comment" ] && [ "${{ github.event.issue.pull_request }}" != "" ]; then
            COMMENTER="${{ github.event.comment.user.login }}"
            
            if [ "$COMMENTER" == "$PR_AUTHOR" ]; then
              REVIEWERS="${{ join(github.event.issue.assignees.*.login, ',') }}"
              COMMENT_URL="${{ github.event.comment.html_url }}"
              
              if [ -n "$REVIEWERS" ]; then
                IFS=',' read -ra REVIEWER_ARRAY <<< "$REVIEWERS"
                for reviewer in "${REVIEWER_ARRAY[@]}"; do
                  if [ "$reviewer" != "$PR_AUTHOR" ]; then
                    MESSAGE="üí¨ <b>Author replied in PR #${PR_NUMBER}</b>%0A%0A"
                    MESSAGE+="üìù ${PR_TITLE}%0A"
                    MESSAGE+="üë§ From: @${PR_AUTHOR}%0A"
                    MESSAGE+="üì¶ Repo: ${REPO_NAME}%0A"
                    MESSAGE+="üîó <a href='${COMMENT_URL}'>Check the reply</a>"
                    send_message "$reviewer" "$MESSAGE"
                  fi
                done
              fi
            fi
          fi