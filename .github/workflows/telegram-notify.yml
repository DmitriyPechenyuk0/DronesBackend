name: Telegram PR Notifications

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send personalized Telegram notifications
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          USER_MAPPING: ${{ secrets.TELEGRAM_USER_MAPPING }}
        run: |
          send_message() {
            local github_user=$1
            local message=$2
            
            local chat_id=$(echo "$USER_MAPPING" | tr ',' '\n' | grep "^${github_user}:" | cut -d':' -f2)
            
            if [ -n "$chat_id" ]; then
              local json_message=$(echo -n "$message" | jq -Rs .)
              local response=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{\"chat_id\": ${chat_id}, \"text\": ${json_message}, \"parse_mode\": \"HTML\", \"disable_web_page_preview\": true}")
              
              echo "Sent to $github_user (chat_id: $chat_id)"
              echo "Response: $response"
            else
              echo "No chat_id found for user: $github_user"
            fi
          }
          
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          PR_TITLE="${{ github.event.pull_request.title || github.event.issue.title }}"
          PR_URL="${{ github.event.pull_request.html_url || github.event.issue.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login || github.event.issue.user.login }}"
          REPO_NAME="${{ github.repository }}"
          EVENT_NAME="${{ github.event_name }}"
          IS_PULL_REQUEST="${{ github.event.issue.pull_request }}"
          ACTION="${{ github.event.action }}"
          
          # Handle PR reviews
          if [ "$EVENT_NAME" = "pull_request_review" ]; then
            REVIEWER="${{ github.event.review.user.login }}"
            STATE="${{ github.event.review.state }}"
            REVIEW_URL="${{ github.event.review.html_url }}"
            
            case "$STATE" in
              approved)
                MESSAGE="âœ… <b>Your PR #${PR_NUMBER} got approved!</b>

          ğŸ“ ${PR_TITLE}
          ğŸ‘ Approved by: @${REVIEWER}
          ğŸ“¦ Repo: ${REPO_NAME}
          ğŸ”— <a href='${PR_URL}'>Check it out</a>"
                send_message "$PR_AUTHOR" "$MESSAGE"
                ;;
              changes_requested)
                MESSAGE="ğŸ”§ <b>Changes needed on PR #${PR_NUMBER}</b>

          ğŸ“ ${PR_TITLE}
          ğŸ‘¤ Reviewer: @${REVIEWER}
          ğŸ’¬ Time to fix some stuff
          ğŸ“¦ Repo: ${REPO_NAME}
          ğŸ”— <a href='${REVIEW_URL}'>See what's up</a>"
                send_message "$PR_AUTHOR" "$MESSAGE"
                ;;
              commented)
                MESSAGE="ğŸ’¬ <b>New review comment on PR #${PR_NUMBER}</b>

          ğŸ“ ${PR_TITLE}
          ğŸ‘¤ From: @${REVIEWER}
          ğŸ“¦ Repo: ${REPO_NAME}
          ğŸ”— <a href='${REVIEW_URL}'>Read it</a>"
                send_message "$PR_AUTHOR" "$MESSAGE"
                ;;
            esac
          fi
          
          # Handle PR review comments
          if [ "$EVENT_NAME" = "pull_request_review_comment" ]; then
            COMMENTER="${{ github.event.comment.user.login }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            
            if [ "$COMMENTER" != "$PR_AUTHOR" ]; then
              MESSAGE="ğŸ’­ <b>Code comment on your PR #${PR_NUMBER}</b>

          ğŸ“ ${PR_TITLE}
          ğŸ‘¤ From: @${COMMENTER}
          ğŸ“¦ Repo: ${REPO_NAME}
          ğŸ”— <a href='${COMMENT_URL}'>Check the comment</a>"
              send_message "$PR_AUTHOR" "$MESSAGE"
            fi
          fi
          
          # Handle issue comments (PR comments)
          if [ "$EVENT_NAME" = "issue_comment" ] && [ -n "$IS_PULL_REQUEST" ]; then
            COMMENTER="${{ github.event.comment.user.login }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            
            if [ "$COMMENTER" != "$PR_AUTHOR" ]; then
              MESSAGE="ğŸ’¬ <b>Reply on your PR #${PR_NUMBER}</b>

          ğŸ“ ${PR_TITLE}
          ğŸ‘¤ From: @${COMMENTER}
          ğŸ“¦ Repo: ${REPO_NAME}
          ğŸ”— <a href='${COMMENT_URL}'>See the reply</a>"
              send_message "$PR_AUTHOR" "$MESSAGE"
            else
              # Author replied - notify reviewers
              REVIEWERS="${{ join(github.event.issue.assignees.*.login, ',') }}"
              
              if [ -n "$REVIEWERS" ]; then
                IFS=',' read -ra REVIEWER_ARRAY <<< "$REVIEWERS"
                for reviewer in "${REVIEWER_ARRAY[@]}"; do
                  reviewer=$(echo "$reviewer" | xargs)
                  if [ "$reviewer" != "$PR_AUTHOR" ]; then
                    MESSAGE="ğŸ’¬ <b>Author replied in PR #${PR_NUMBER}</b>

          ğŸ“ ${PR_TITLE}
          ğŸ‘¤ From: @${PR_AUTHOR}
          ğŸ“¦ Repo: ${REPO_NAME}
          ğŸ”— <a href='${COMMENT_URL}'>Check the reply</a>"
                    send_message "$reviewer" "$MESSAGE"
                  fi
                done
              fi
            fi
          fi
          
          # Handle PR events (opened, synchronize, ready_for_review)
          if [ "$EVENT_NAME" = "pull_request" ]; then
            REVIEWERS="${{ join(github.event.pull_request.requested_reviewers.*.login, ',') }}"
            
            case "$ACTION" in
              opened)
                if [ -n "$REVIEWERS" ]; then
                  IFS=',' read -ra REVIEWER_ARRAY <<< "$REVIEWERS"
                  for reviewer in "${REVIEWER_ARRAY[@]}"; do
                    reviewer=$(echo "$reviewer" | xargs)
                    MESSAGE="ğŸ†• <b>New PR #${PR_NUMBER} needs your review</b>

          ğŸ“ ${PR_TITLE}
          ğŸ‘¤ Author: @${PR_AUTHOR}
          ğŸ“¦ Repo: ${REPO_NAME}
          ğŸ”— <a href='${PR_URL}'>Start reviewing</a>"
                    send_message "$reviewer" "$MESSAGE"
                  done
                fi
                ;;
              synchronize)
                if [ -n "$REVIEWERS" ]; then
                  COMMITS_URL="${PR_URL}/commits"
                  IFS=',' read -ra REVIEWER_ARRAY <<< "$REVIEWERS"
                  for reviewer in "${REVIEWER_ARRAY[@]}"; do
                    reviewer=$(echo "$reviewer" | xargs)
                    MESSAGE="ğŸ”„ <b>Fresh changes in PR #${PR_NUMBER}</b>

          ğŸ“ ${PR_TITLE}
          ğŸ‘¤ Author: @${PR_AUTHOR}
          âœ¨ New commits pushed
          ğŸ“¦ Repo: ${REPO_NAME}
          ğŸ”— <a href='${COMMITS_URL}'>See what changed</a>"
                    send_message "$reviewer" "$MESSAGE"
                  done
                fi
                ;;
              ready_for_review)
                if [ -n "$REVIEWERS" ]; then
                  IFS=',' read -ra REVIEWER_ARRAY <<< "$REVIEWERS"
                  for reviewer in "${REVIEWER_ARRAY[@]}"; do
                    reviewer=$(echo "$reviewer" | xargs)
                    MESSAGE="âœ¨ <b>PR #${PR_NUMBER} is ready for review</b>

          ğŸ“ ${PR_TITLE}
          ğŸ‘¤ Author: @${PR_AUTHOR}
          ğŸ“¦ Repo: ${REPO_NAME}
          ğŸ”— <a href='${PR_URL}'>Let's review this</a>"
                    send_message "$reviewer" "$MESSAGE"
                  done
                fi
                ;;
            esac
          fi